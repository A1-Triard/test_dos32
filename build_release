#!/bin/sh
set -eu

cd "$(dirname "$(realpath "$0")")"

target=i686-pc-windows-msvc
dos_target=i686-pc-dpmi-hxrt

name=tstdos32

if ! [ -e HXRT216.zip ]; then
    wget https://www.japheth.de/Download/HX/HXRT216.zip || exit 1
fi

if ! [ -d HXRT216 ]; then
    mkdir HXRT216 || exit 1
    unzip -d HXRT216 HXRT216.zip || exit 1
fi

cargo +nightly build \
    --verbose \
    -Z build-std=core,panic_abort \
    -Z build-std-features=panic_immediate_abort \
    --target "$target" \
    --release \
    || exit 1

mkdir -p target/"$dos_target"/release || exit 1
cp -rf target/"$target"/release/build/tstdos32-*/out/CODEPAGE \
    target/"$dos_target"/release \
    || exit 1
cp -f target/"$target"/release/"$name".exe \
    target/"$dos_target"/release/"$name".exe \
    || exit 1
wine HXRT216/BIN/PESTUB.EXE -v -n -x -s \
    target/"$dos_target"/release/"$name".exe \
    HXRT216/BIN/DPMIST32.BIN \
    || exit 1
cp -f HXRT216/BIN/DPMILD32.EXE \
    HXRT216/BIN/HDPMI32.EXE \
    target/"$dos_target"/release \
    || exit 1
